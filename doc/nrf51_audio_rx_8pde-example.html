<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RadioHead: nrf51_audio_rx.pde</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RadioHead
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">nrf51_audio_rx.pde</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line">// nrf51_audio_rx.pde</div>
<div class="line">// Sample sketch for nRF51822 and RadioHead</div>
<div class="line">//</div>
<div class="line">// Plays audio samples received in the radio receiver </div>
<div class="line">// through a MCP4725 DAC such as on a SparkFun I2C DAC Breakout - MCP4725 (BOB-12918)</div>
<div class="line">// works with matching transmitter (see nrf51_audio_tx.pde)</div>
<div class="line">// Works with RedBear nRF51822 board.</div>
<div class="line">// See examples/nrf51_audiotx/nrf51_audio.pdf for connection details</div>
<div class="line"> </div>
<div class="line">#include &lt;nrf51.h&gt;</div>
<div class="line">#include &lt;nrf51_bitfields.h&gt;</div>
<div class="line">#include &lt;esb/nrf_esb.h&gt;</div>
<div class="line">#include &lt;RH_NRF51.h&gt;</div>
<div class="line">#include &lt;Wire.h&gt;</div>
<div class="line"> </div>
<div class="line">// Number of samples per second to play at.</div>
<div class="line">// Should match SAMPLE_RATE in nrf51_audio_tx</div>
<div class="line">// The limiting factor is the time it takes to output a new sample through the DAC</div>
<div class="line">#define SAMPLE_RATE 5000</div>
<div class="line"> </div>
<div class="line">// Number of 8 bit samples per packet</div>
<div class="line">// Should equal or exceed the PACKET_SIZE in nrf51_audio_tx</div>
<div class="line">#define MAX_PACKET_SIZE 255</div>
<div class="line"> </div>
<div class="line">// Singleton instance of the radio driver</div>
<div class="line">RH_NRF51 driver;</div>
<div class="line"> </div>
<div class="line">void setup() </div>
<div class="line">{</div>
<div class="line">  delay(1000);</div>
<div class="line">  Serial.begin(9600);</div>
<div class="line">  while (!Serial) </div>
<div class="line">    ; // wait for serial port to connect. </div>
<div class="line"> </div>
<div class="line">  if (!driver.init())</div>
<div class="line">    Serial.println(&quot;init failed&quot;);</div>
<div class="line">  // Defaults after init are 2.402 GHz (channel 2), 2Mbps, 0dBm</div>
<div class="line"> </div>
<div class="line">  // Set up TIMER</div>
<div class="line">  // Use TIMER0</div>
<div class="line">  // Timer freq before prescaling is 16MHz (VARIANT_MCK)</div>
<div class="line">  // We set up a 32 bit timer that restarts every 100us and outputs a new sample</div>
<div class="line">  NRF_TIMER0-&gt;PRESCALER = 0 &lt;&lt; TIMER_PRESCALER_PRESCALER_Pos; </div>
<div class="line">  NRF_TIMER0-&gt;MODE = TIMER_MODE_MODE_Timer &lt;&lt; TIMER_BITMODE_BITMODE_Pos;</div>
<div class="line">  NRF_TIMER0-&gt;BITMODE = TIMER_BITMODE_BITMODE_32Bit &lt;&lt; TIMER_BITMODE_BITMODE_Pos;</div>
<div class="line">  NRF_TIMER0-&gt;CC[0] = VARIANT_MCK / SAMPLE_RATE; // Counts per cycle</div>
<div class="line">  // When timer count expires, its cleared and restarts</div>
<div class="line">  NRF_TIMER0-&gt;SHORTS = TIMER_SHORTS_COMPARE0_CLEAR_Msk;</div>
<div class="line">  NRF_TIMER0-&gt;TASKS_START = 1;</div>
<div class="line">  // Enable an interrupt when timer completes</div>
<div class="line">  NRF_TIMER0-&gt;INTENSET = TIMER_INTENSET_COMPARE0_Msk;</div>
<div class="line">  </div>
<div class="line">  // Enable the TIMER0 interrupt, and set the priority </div>
<div class="line">  // TIMER0_IRQHandler() will be called after each sample is available</div>
<div class="line">  NVIC_SetPriority(TIMER0_IRQn, 1);</div>
<div class="line">  NVIC_EnableIRQ(TIMER0_IRQn); </div>
<div class="line"> </div>
<div class="line">  // Initialise comms with the I2C DAC as fast as we can</div>
<div class="line">  // Shame the 51822 does not suport the high speed I2C mode that the DAC does</div>
<div class="line">  Wire.begin(TWI_SCL, TWI_SDA, TWI_FREQUENCY_400K);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">volatile uint32_t count = 0;</div>
<div class="line"> </div>
<div class="line">uint8_t buffer_length = 0;</div>
<div class="line">uint8_t buffer[MAX_PACKET_SIZE];</div>
<div class="line">uint16_t buffer_play_index = 0;</div>
<div class="line"> </div>
<div class="line">// Write this sample to analog out</div>
<div class="line">void analog_out(uint8_t val)</div>
<div class="line">{</div>
<div class="line">  // This takes about 120usecs, which</div>
<div class="line">  // is the limiting factor for our sample rate of 5kHz</div>
<div class="line">  // Writes to MCP4725 DAC over I2C using the Wire library</div>
<div class="line">  Wire.beginTransmission(0x60); // 7 bit addressing</div>
<div class="line">  Wire.write((val &gt;&gt; 4) &amp; 0x0f); </div>
<div class="line">  Wire.write((val &lt;&lt; 4) &amp; 0xf0);  </div>
<div class="line">  Wire.endTransmission();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// Called by timer interrupt</div>
<div class="line">// Output the next available sample</div>
<div class="line">void output_next_sample()</div>
<div class="line">{</div>
<div class="line">  if (buffer_play_index &lt; buffer_length)</div>
<div class="line">  {</div>
<div class="line">    analog_out(buffer[buffer_play_index++]);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void loop() </div>
<div class="line">{</div>
<div class="line">  // Look for a new packet of samples</div>
<div class="line">  if (driver.available())</div>
<div class="line">  {</div>
<div class="line">    // expect one of these every 40ms = 25Hz</div>
<div class="line">    // This takes about 400us:</div>
<div class="line">    buffer_length = sizeof(buffer);</div>
<div class="line">    driver.recv(buffer, &amp;buffer_length);</div>
<div class="line">    buffer_play_index = 0; // Trigger the interrupt playing of this buffer from the start</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// This interrupt handler called when the timer interrupt fires</div>
<div class="line">// Time to output the next sample</div>
<div class="line">void TIMER0_IRQHandler(void)</div>
<div class="line">{</div>
<div class="line">  // It is vitally important that analog output completes before</div>
<div class="line">  // the next interrupt becomes due!</div>
<div class="line">  output_next_sample();</div>
<div class="line">  NRF_TIMER0-&gt;EVENTS_COMPARE[0] = 0; // Clear the COMPARE[0] event and the interrupt</div>
<div class="line">}</div>
<div class="line"> </div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
